<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bake‚Äëa‚ÄëCake ‚Äì Drag ‚Ä¢ Drop ‚Ä¢ Blow</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
<style>
  :root{--bg:#fff7ec;--primary:#ff8ba7;--dark:#403d58;--radius:18px;}
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",Roboto,sans-serif;user-select:none;}
  body{background:radial-gradient(circle at top left,#ffe5ec,var(--bg));color:var(--dark);display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:2rem 1rem 3rem;}
  h1{margin-bottom:1rem;font-size:2rem;text-align:center;}
  .card{width:100%;max-width:460px;background:#fff;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.1);padding:1.6rem;display:flex;flex-direction:column;gap:1rem;}
  .step{display:none;flex-direction:column;gap:1rem;}
  .step.active{display:flex;}
  .workspace{display:flex;gap:.9rem;justify-content:center;}
  .palette{display:flex;flex-wrap:wrap;gap:.6rem;max-width:180px;align-content:flex-start;}
  .draggable{width:52px;height:52px;border-radius:var(--radius);border:2px solid var(--dark);display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:grab;}
  .pan{width:260px;height:320px;position:relative;border-bottom:10px solid #cacaca;border-radius:0 0 8px 8px;background:#fafafa;display:flex;justify-content:center;align-items:flex-end;overflow:visible;}
  .layer{position:absolute;left:50%;transform:translateX(-50%);height:40px;border-radius:6px;box-shadow:0 0 0 4px #fff inset;}
  .topping{position:absolute;font-size:2.2rem;width:44px;height:44px;transform:translateX(-50%);}
  button{align-self:center;padding:.8rem 1.3rem;border-radius:var(--radius);background:var(--primary);color:#fff;font-size:1rem;border:none;cursor:pointer;transition:transform .1s;}
  button:disabled{opacity:.5;cursor:not-allowed;}
  button:active{transform:scale(.97);}  
  #msg{display:none;text-align:center;font-size:1.9rem;font-weight:700;margin-top:1rem;}
  @keyframes flicker{from{transform:translateX(-50%) scaleY(1);}to{transform:translateX(-50%) scaleY(.9);}}
  input[type="text"]{padding:.7rem 1rem;border:2px solid var(--primary);border-radius:var(--radius);font-size:1rem;width:100%;}
</style>
</head>
<body>
<h1>üéÇ Bake-a-Cake Birthday Card</h1>
<div class="card">
  <!-- STEP 0: Microphone permission -->
  <div class="step active" id="step-mic">
    <p style="text-align:center;font-weight:600;">To blow out the candle later, we‚Äôll need your mic.</p>
    <button id="enableMic">Enable Microphone</button>
    <button id="toName" disabled>Continue ‚Üí</button>
    <small id="micStatus" style="text-align:center;opacity:.7;"></small>
  </div>

  <!-- STEP 1: Name -->
  <div class="step" id="step-name">
    <p style="text-align:center;font-weight:600;">Who‚Äôs this cake for?</p>
    <input type="text" id="nameInput" placeholder="Type a name‚Ä¶" />
    <button id="toLayers" disabled>Continue ‚Üí</button>
  </div>

  <!-- STEP 2: Layers -->
  <div class="step" id="step-layers">
    <p style="text-align:center;font-weight:600;">Drag layers onto the pan</p>
    <div class="workspace">
      <div id="palette-layers" class="palette">
        <div class="draggable" draggable="true" data-type="layer" data-color="#ff8ba7" style="background:#ff8ba7;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#a0e7e5" style="background:#a0e7e5;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#ffd166" style="background:#ffd166;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#cdb4db" style="background:#cdb4db;"></div>
      </div>
      <div id="pan-layers" class="pan" ondragover="event.preventDefault()"></div>
    </div>
    <button id="toTopping" disabled>Continue ‚Üí</button>
  </div>

  <!-- STEP 3: Toppings -->
  <div class="step" id="step-topping">
    <p style="text-align:center;font-weight:600;">Add as many toppings as you like</p>
    <div class="workspace">
      <div id="palette-topping" class="palette">
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üçì">üçì</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üçí">üçí</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üç©">üç©</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üç™">üç™</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üßÅ">üßÅ</div>
      </div>
      <div id="pan-topping" class="pan" ondragover="event.preventDefault()"></div>
    </div>
    <button id="toFinish" disabled>Continue ‚Üí</button>
  </div>

  <!-- STEP 4: Finish -->
  <div class="step" id="step-finish" style="align-items:center;">
    <p style="text-align:center;font-size:1.2rem;">Click or blow to blow out the candle!</p>
    <div id="pan-finish" class="pan" style="margin-bottom:1rem;"></div>
    <div id="msg"></div>
  </div>
</div>
<script>
// GLOBAL STATE
let layers=[];           // color strings
let toppings=[];         // emoji strings
let recipient="Birthday Star";
let micStream=null;      // MediaStream or null
const layerHeight=40;
// UTILS
function renderCake(container, includeToppings=false){
  container.innerHTML='';
  layers.forEach((color,idx)=>{
    const div=document.createElement('div');
    div.className='layer';
    div.style.width=(220-idx*24)+'px';
    div.style.bottom=(idx*layerHeight)+'px';
    div.style.background=color;
    container.appendChild(div);
  });
  if(includeToppings){
    toppings.forEach((emoji,idx)=>{
      const top=document.createElement('div');
      top.className='topping';
      top.textContent=emoji;
      const spread=48;
      top.style.left=`calc(50% + ${(idx-(toppings.length-1)/2)*spread}px)`;
      top.style.bottom=(layers.length*layerHeight + 6)+'px';
      container.appendChild(top);
    });
  }
}

// MIC STEP
const enableMicBtn=document.getElementById('enableMic');
const toNameBtn=document.getElementById('toName');
const micStatus=document.getElementById('micStatus');

enableMicBtn.addEventListener('click',()=>{
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    micStatus.textContent='Microphone API not supported, but you can still continue.';
    toNameBtn.disabled=false;
    return;
  }
  enableMicBtn.disabled=true;
  enableMicBtn.textContent='Requesting‚Ä¶';
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    micStream=stream;
    enableMicBtn.textContent='Microphone enabled ‚úî';
    micStatus.textContent='Great! You can blow out the candle later.';
    toNameBtn.disabled=false;
  }).catch(()=>{
    enableMicBtn.textContent='Enable Microphone (optional)';
    micStatus.textContent='Permission denied ‚Äì click Continue to proceed without blowing feature.';
    toNameBtn.disabled=false;
  });
});

toNameBtn.addEventListener('click',()=>{
  document.getElementById('step-mic').classList.remove('active');
  document.getElementById('step-name').classList.add('active');
  document.getElementById('nameInput').focus();
});

// NAME STEP
const nameInput=document.getElementById('nameInput');
const toLayersBtn=document.getElementById('toLayers');
nameInput.addEventListener('input',()=>{toLayersBtn.disabled=!nameInput.value.trim();});

toLayersBtn.addEventListener('click',()=>{
  recipient=nameInput.value.trim()||'Birthday Star';
  document.getElementById('step-name').classList.remove('active');
  document.getElementById('step-layers').classList.add('active');
});

// DRAG SUPPORT
function handleDragStart(e){
  const t=e.target;
  e.dataTransfer.setData('text/plain',JSON.stringify({type:t.dataset.type,color:t.dataset.color,emoji:t.dataset.emoji}));
}
[...document.querySelectorAll('.draggable')].forEach(el=>el.addEventListener('dragstart',handleDragStart));

// LAYERS STEP
const panLayers=document.getElementById('pan-layers');
const toToppingBtn=document.getElementById('toTopping');

panLayers.addEventListener('drop',e=>{
  e.preventDefault();
  const d=JSON.parse(e.dataTransfer.getData('text/plain'));
  if(d.type==='layer'&&layers.length<6){
    layers.push(d.color);
    renderCake(panLayers);
    toToppingBtn.disabled=false;
  }
});

toToppingBtn.addEventListener('click',()=>{
  document.getElementById('step-layers').classList.remove('active');
  document.getElementById('step-topping').classList.add('active');
  renderCake(document.getElementById('pan-topping'),true);
});

// TOPPINGS STEP
const panTopping=document.getElementById('pan-topping');
const toFinishBtn=document.getElementById('toFinish');

panTopping.addEventListener('drop',e=>{
  e.preventDefault();
  const d=JSON.parse(e.dataTransfer.getData('text/plain'));
  if(d.type==='topping'){
    toppings.push(d.emoji);
    renderCake(panTopping,true);
    toFinishBtn.disabled=false;
  }
});

toFinishBtn.addEventListener('click',()=>{
  document.getElementById('step-topping').classList.remove('active');
  document.getElementById('step-finish').classList.add('active');
  const panFinish=document.getElementById('pan-finish');
  renderCake(panFinish,true);
  // Candle
  const candle=document.createElement('div');
  candle.style.position='absolute';
  candle.style.width='12px';
  candle.style.height='46px';
  candle.style.background='repeating-linear-gradient(45deg,#ffd1dc 0 4px,#ff8ba7 4px 8px)';
  candle.style.bottom=(layers.length*layerHeight + 50)+'px';
  candle.style.left='50%';
  candle.style.transform='translateX(-50%)';
  const flame=document.createElement('div');
  flame.style.position='absolute';
  flame.style.width='16px';
  flame.style.height='20px';
  flame.style.left='50%';
  flame.style.top='-20px';
  flame.style.transform='translateX(-50%)';
  flame.style.background='radial-gradient(circle at 50% 60%,#fff 0 20%,#ffda66 20% 60%,#ff8c00 60% 100%)';
  flame.style.borderRadius='50% 50% 50% 50%/60% 60% 40% 40%';
  flame.style.animation='flicker .4s infinite alternate';
  candle.appendChild(flame);
  panFinish.appendChild(candle);

  // Celebration
  const celebrate=()=>{
    flame.style.display='none';
    document.getElementById('msg').textContent=`Happy Birthday, ${recipient}!`;
    document.getElementById('msg').style.display='block';
    confetti({particleCount:200,spread:100,origin:{y:0.6}});
    window.removeEventListener('click',celebrate);
    if(micStream) micStream.getTracks().forEach(t=>t.stop());
  };
  window.addEventListener('click',celebrate);

  // Blow detection if micStream available, else attempt
  if(micStream){setupBlowDetection(micStream,celebrate);}else if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{micStream=s;setupBlowDetection(s,celebrate);}).catch(()=>{});
  }
});

function setupBlowDetection(stream,callback){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const analyser=ctx.createAnalyser();
  analyser.fftSize=256;
  ctx.createMediaStreamSource(stream).connect(analyser);
  const data=new Uint8Array(analyser.frequencyBinCount);
  const threshold=100;
  (function listen(){
    analyser.getByteFrequencyData(data);
    let sum=0;for(let i=0;i<data.length;i++)sum+=data[i];
    if(sum>threshold*data.length){callback();} else {requestAnimationFrame(listen);} })();
}
</script>
</body>
</html>
