<script>
// GLOBAL STATE
let layers = [], toppings = [];
let recipient = "Birthday Star", micStream = null;
let blowCount = 0, lastBlow = 0;
const layerHeight = 40, BLOW_COOLDOWN = 1000;

// DOM ELEMENTS
const stepMic = document.getElementById("step-mic");
const stepName = document.getElementById("step-name");
const stepLayers = document.getElementById("step-layers");
const stepTopping = document.getElementById("step-topping");
const stepFinish = document.getElementById("step-finish");

const enableMic = document.getElementById("enableMic");
const toName = document.getElementById("toName");
const micStatus = document.getElementById("micStatus");

const nameInput = document.getElementById("nameInput");
const toLayers = document.getElementById("toLayers");

const panLayers = document.getElementById("pan-layers");
const toTopping = document.getElementById("toTopping");

const panTopping = document.getElementById("pan-topping");
const toFinish = document.getElementById("toFinish");

// UTIL: render cake
function renderCake(container, includeToppings = false) {
  container.innerHTML = '';
  layers.forEach((color, idx) => {
    const div = document.createElement('div');
    div.className = 'layer';
    div.style.width = (220 - idx * 24) + 'px';
    div.style.bottom = (idx * layerHeight) + 'px';
    div.style.background = color;
    container.appendChild(div);
  });
  if (includeToppings) {
    toppings.forEach((emoji, idx) => {
      const top = document.createElement('div');
      top.className = 'topping';
      top.textContent = emoji;
      top.style.left = `calc(50% + ${(idx - (toppings.length - 1) / 2) * 48}px)`;
      top.style.bottom = (layers.length * layerHeight + 6) + 'px';
      container.appendChild(top);
    });
  }
}

// STEP 0 – mic
enableMic.addEventListener('click', () => {
  if (!navigator.mediaDevices?.getUserMedia) {
    micStatus.textContent = 'No mic API, but you can continue.';
    toName.disabled = false;
    return;
  }
  enableMic.disabled = true;
  enableMic.textContent = 'Requesting…';
  navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
    micStream = s;
    enableMic.textContent = 'Microphone enabled ✔';
    micStatus.textContent = 'Great! Blow detection ready.';
    toName.disabled = false;
  }).catch(() => {
    enableMic.textContent = 'Enable Microphone (optional)';
    micStatus.textContent = 'Permission denied – continue without blowing feature.';
    toName.disabled = false;
  });
});
toName.addEventListener('click', () => {
  stepMic.classList.remove('active');
  stepName.classList.add('active');
  nameInput.focus();
});

// STEP 1 – name
nameInput.addEventListener('input', () => toLayers.disabled = !nameInput.value.trim());
toLayers.addEventListener('click', () => {
  recipient = nameInput.value.trim() || 'Birthday Star';
  stepName.classList.remove('active');
  stepLayers.classList.add('active');
});

// drag helper
document.querySelectorAll('.draggable').forEach(el => el.addEventListener('dragstart', e => {
  e.dataTransfer.setData('text/plain', JSON.stringify(el.dataset));
}));

// STEP 2 – layers
panLayers.addEventListener('drop', e => {
  e.preventDefault();
  const d = JSON.parse(e.dataTransfer.getData('text/plain'));
  if (d.type === 'layer' && layers.length < 6) {
    layers.push(d.color);
    renderCake(panLayers);
    toTopping.disabled = false;
  }
});
toTopping.addEventListener('click', () => {
  stepLayers.classList.remove('active');
  stepTopping.classList.add('active');
  renderCake(panTopping, true);
});

// STEP 3 – toppings
panTopping.addEventListener('drop', e => {
  e.preventDefault();
  const d = JSON.parse(e.dataTransfer.getData('text/plain'));
  if (d.type === 'topping') {
    toppings.push(d.emoji);
    renderCake(panTopping, true);
    toFinish.disabled = false;
  }
});
toFinish.addEventListener('click', () => {
  stepTopping.classList.remove('active');
  stepFinish.classList.add('active');
  const panFinish = document.getElementById('pan-finish');
  renderCake(panFinish, true);

  // candle & flame
  const candle = document.createElement('div');
  candle.style.cssText = 'position:absolute;width:12px;height:46px;background:repeating-linear-gradient(45deg,#ffd1dc 0 4px,#ff8ba7 4px 8px);bottom:' + (layers.length * layerHeight + 50) + 'px;left:50%;transform:translateX(-50%);';
  const flame = document.createElement('div');
  flame.style.cssText = 'position:absolute;width:16px;height:20px;left:50%;top:-20px;transform:translateX(-50%);background:radial-gradient(circle at 50% 60%,#fff 0 20%,#ffda66 20% 60%,#ff8c00 60% 100%);border-radius:50%/60% 60% 40% 40%;animation:flicker .4s infinite alternate;';
  candle.appendChild(flame);
  panFinish.appendChild(candle);

  const msg = document.getElementById('msg');

  const celebrate1 = () => {
    flame.style.display = 'none';
    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
    msg.textContent = `Happy Birthday, ${recipient}!`;
    msg.style.display = 'block';
    msg.style.opacity = '1';
  };
  const celebrate2 = () => {
    msg.style.opacity = '0';
    setTimeout(() => {
      msg.textContent = "You're the absolute best little brother ever. Happy birthday!";
      msg.style.opacity = '1';
      confetti({ particleCount: 180, spread: 120, origin: { y: 0.6 } });
    }, 800);
  };
  const handleBlow = () => {
    blowCount ? celebrate2() : celebrate1();
    blowCount++;
  };
  window.addEventListener('click', handleBlow);

  // Blow detection
  if (micStream) {
    setupBlowDetection(micStream, handleBlow);
  } else if (navigator.mediaDevices?.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
      micStream = s;
      setupBlowDetection(s, handleBlow);
    });
  }
});

function setupBlowDetection(stream, onBlow) {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 256;
  ctx.createMediaStreamSource(stream).connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);
  (function listen() {
    if (ctx.state === "suspended") ctx.resume();
    analyser.getByteFrequencyData(data);
    const sum = data.reduce((a, b) => a + b, 0);
    const now = Date.now();
    if (sum > 100 * data.length && now - lastBlow > BLOW_COOLDOWN) {
      lastBlow = now;
      onBlow();
    }
    requestAnimationFrame(listen);
  })();
}
</script>
