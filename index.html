<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bake-a-Cake ‚Äì Drag ‚Ä¢ Drop ‚Ä¢ Blow</title>

<!-- DM Sans -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">

<!-- confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

<style>
:root{--bg:#fff7ec;--primary:#ff8ba7;--dark:#403d58;--radius:18px;}
*{box-sizing:border-box;margin:0;padding:0;font-family:"DM Sans",sans-serif;user-select:none;}
body{background:radial-gradient(circle at top left,#ffe5ec,var(--bg));color:var(--dark);
     display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:2rem 1rem 3rem;}
h1{margin-bottom:1.2rem;font-size:2rem;text-align:center;}
button{padding:.85rem 1.6rem;border-radius:9999px;background:var(--primary);color:#fff;
       font-size:1rem;border:none;cursor:pointer;transition:transform .1s;}
button:disabled{opacity:.5;cursor:not-allowed;}button:active{transform:scale(.97);}

/* LAYOUT  */
.card{width:100%;max-width:460px;background:#fff;border-radius:var(--radius);
      box-shadow:0 4px 12px rgba(0,0,0,.1);padding:1.6rem;display:flex;flex-direction:column;gap:1rem;}
.step{display:none;flex-direction:column;gap:1rem;}
.step.active{display:flex;}

.workspace{display:flex;gap:.9rem;justify-content:center;}
.palette{display:flex;flex-wrap:wrap;gap:.6rem;max-width:180px;align-content:flex-start;}
.draggable{width:52px;height:52px;border-radius:var(--radius);border:2px solid var(--dark);
           display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:grab;}
.pan{width:260px;height:320px;position:relative;border-bottom:10px solid #cacaca;
     border-radius:0 0 8px 8px;background:#fafafa;display:flex;justify-content:center;align-items:flex-end;}
.layer{position:absolute;left:50%;transform:translateX(-50%);height:40px;border-radius:6px;box-shadow:0 0 0 4px #fff inset;}
.topping{position:absolute;font-size:2.2rem;width:44px;height:44px;transform:translateX(-50%);}

#inlineMsg{display:none;text-align:center;font-size:1.9rem;font-weight:700;margin-top:1rem;}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;
         justify-content:center;opacity:0;pointer-events:none;transition:opacity .6s;}
#overlay.visible{opacity:1;pointer-events:auto;}
#overlayMsg{font-size:1.9rem;font-weight:700;color:#fff;opacity:0;transform:translateY(40px);
            transition:opacity .8s,transform .8s;text-align:center;max-width:80%;}
#overlay.visible #overlayMsg{opacity:1;transform:translateY(0);}
@keyframes flicker{from{transform:translateX(-50%) scaleY(1);}to{transform:translateX(-50%) scaleY(.9);}}

input[type=text]{padding:.7rem 1rem;border:2px solid var(--primary);border-radius:var(--radius);font-size:1rem;width:100%;}
/* landing */
#landing{max-width:500px;background:#fff;padding:2rem;border-radius:18px;box-shadow:0 4px 12px rgba(0,0,0,.1);
         display:flex;flex-direction:column;gap:1rem;}
</style>
</head>
<body>

<h1>üéÇ Bake-a-Cake Birthday Card</h1>

<!-- Landing (shown only when no URL params) -->
<div id="landing" hidden>
  <p style="text-align:center;font-weight:600;">What would you like to do?</p>
  <button id="goBuilder">üõ†Ô∏è Build a custom card</button>
  <button id="goSimple">üç∞ Just bake a cake</button>
</div>

<!-- Main wizard -->
<div class="card" id="wizard" hidden>
  <!-- STEP 0: mic -->
  <div class="step active" id="step-mic">
    <p style="text-align:center;font-weight:600;">To blow out the candle later, we‚Äôll need your mic.</p>
    <button id="enableMic">Enable Microphone</button>
    <button id="toName" disabled>Continue ‚Üí</button>
    <small id="micStatus" style="text-align:center;opacity:.7;"></small>
  </div>

  <!-- STEP 1: name -->
  <div class="step" id="step-name">
    <p style="text-align:center;font-weight:600;">Who‚Äôs this cake for?</p>
    <input id="nameInput" type="text" placeholder="Type a name‚Ä¶" />
    <button id="toLayers" disabled>Continue ‚Üí</button>
  </div>

  <!-- STEP 2: layers -->
  <div class="step" id="step-layers">
    <p style="text-align:center;font-weight:600;">Drag layers onto the pan</p>
    <div class="workspace">
      <div id="palette-layers" class="palette">
        <div class="draggable" draggable="true" data-type="layer" data-color="#ff8ba7" style="background:#ff8ba7;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#a0e7e5" style="background:#a0e7e5;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#ffd166" style="background:#ffd166;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#cdb4db" style="background:#cdb4db;"></div>
      </div>
      <div id="pan-layers" class="pan" ondragover="event.preventDefault()"></div>
    </div>
    <button id="toTopping" disabled>Continue ‚Üí</button>
  </div>

  <!-- STEP 3: toppings -->
  <div class="step" id="step-topping">
    <p style="text-align:center;font-weight:600;">Add as many toppings as you like</p>
    <div class="workspace">
      <div id="palette-topping" class="palette">
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üçì">üçì</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üçí">üçí</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üç©">üç©</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üç™">üç™</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üßÅ">üßÅ</div>
      </div>
      <div id="pan-topping" class="pan" ondragover="event.preventDefault()"></div>
    </div>
    <button id="toFinish" disabled>Continue ‚Üí</button>
  </div>

  <!-- STEP 4: finish -->
  <div class="step" id="step-finish" style="align-items:center;">
    <p style="text-align:center;font-size:1.2rem;">Click or blow to blow out the candle!</p>
    <div id="pan-finish" class="pan" style="margin-bottom:1rem;"></div>
    <div id="inlineMsg"></div>
  </div>
</div>

<!-- overlay -->
<div id="overlay"><div id="overlayMsg"></div></div>

<script>
/* ---------- URL PARAMS / LANDING ---------- */
const urlParams=new URLSearchParams(location.search);
const presetName=urlParams.get('name')?decodeURIComponent(urlParams.get('name')):null;
const encryptedMsg=urlParams.get('msg')?decodeURIComponent(urlParams.get('msg')):null;
const shiftKey=urlParams.get('key')?parseInt(urlParams.get('key')):null;

const hasPresets= presetName && encryptedMsg && shiftKey;

/* Landing logic */
const landingEl=document.getElementById('landing');
const wizardEl =document.getElementById('wizard');

if(!hasPresets){
  landingEl.hidden=false;
  document.getElementById('goBuilder').onclick=()=>location.href='builder.html';
  document.getElementById('goSimple').onclick=()=>{
    landingEl.hidden=true;wizardEl.hidden=false;
  };
}else{
  wizardEl.hidden=false; // jump straight in
}

/* ---------- STATE ---------- */
let layers=[],toppings=[],recipient=presetName||'Birthday Star';
const defaultClearMsg='Happy birthday to the greatest person ever';
let secretMessageCipher=encryptedMsg||defaultClearMsg, secretShift=shiftKey||0;
let micStream=null, blowCount=0, lastBlow=0;
const layerHeight=40,BLOW_COOLDOWN=1000;

/* ---------- DOM refs ---------- */
const stepMic=document.getElementById('step-mic'),stepName=document.getElementById('step-name'),
      stepLayers=document.getElementById('step-layers'),stepTopping=document.getElementById('step-topping'),
      stepFinish=document.getElementById('step-finish');

const enableMic=document.getElementById('enableMic'),toName=document.getElementById('toName'),
      micStatus=document.getElementById('micStatus'),nameInput=document.getElementById('nameInput'),
      toLayers=document.getElementById('toLayers');

const panLayers=document.getElementById('pan-layers'),toTopping=document.getElementById('toTopping');
const panTopping=document.getElementById('pan-topping'),toFinish=document.getElementById('toFinish');

const inlineMsg=document.getElementById('inlineMsg'),overlay=document.getElementById('overlay'),
      overlayMsg=document.getElementById('overlayMsg');

/* ---------- Caesar Cipher ---------- */
function caesarDecrypt(str,shift){
  return str.split('').map(ch=>{
    const c=ch.charCodeAt(0);
    if(c>=65&&c<=90) return String.fromCharCode(((c-65-shift+26*100)%26)+65);
    if(c>=97&&c<=122) return String.fromCharCode(((c-97-shift+26*100)%26)+97);
    return ch;
  }).join('');
}

/* ---------- INIT WIZARD based on presets ---------- */
if(hasPresets){
  toName.disabled=false;               // enable ‚ÄúContinue‚Äù in mic step
  stepName.style.display='none';       // skip ask-name step entirely
}else{
  /* no presets, normal flow */
  nameInput.addEventListener('input',()=>toLayers.disabled=!nameInput.value.trim());
}

/* ---------- Render helpers ---------- */
function renderCake(container,includeTops=false){
  container.innerHTML='';
  layers.forEach((color,i)=>{
    const d=document.createElement('div');d.className='layer';
    d.style.width=(220-i*24)+'px';d.style.bottom=(i*layerHeight)+'px';
    d.style.background=color;container.appendChild(d);
  });
  if(includeTops){
    toppings.forEach((emoji,i)=>{
      const t=document.createElement('div');t.className='topping';t.textContent=emoji;
      t.style.left=`calc(50% + ${(i-(toppings.length-1)/2)*48}px)`;
      t.style.bottom=(layers.length*layerHeight+6)+'px';container.appendChild(t);
    });
  }
}

/* ---------- Mic permission ---------- */
enableMic.addEventListener('click',()=>{
  if(!navigator.mediaDevices?.getUserMedia){
    micStatus.textContent='No mic API ‚Äì continue without.';toName.disabled=false;return;
  }
  enableMic.disabled=true;enableMic.textContent='Requesting‚Ä¶';
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    micStream=stream;enableMic.textContent='Mic enabled ‚úî';
    micStatus.textContent='Blow detection ready.';toName.disabled=true?false:toName.disabled=false;
  }).catch(()=>{enableMic.textContent='Enable Microphone (optional)';toName.disabled=false;});
});
toName.addEventListener('click',()=>{
  stepMic.classList.remove('active');
  if(hasPresets){stepLayers.classList.add('active');}else{stepName.classList.add('active');nameInput.focus();}
});

/* name entry only if no presets */
toLayers.addEventListener('click',()=>{
  recipient=nameInput.value.trim()||'Birthday Star';
  stepName.classList.remove('active');stepLayers.classList.add('active');
});

/* ---------- Drag support ---------- */
document.querySelectorAll('.draggable').forEach(el=>el.addEventListener('dragstart',e=>{
  e.dataTransfer.setData('text/plain',JSON.stringify(el.dataset));
}));

/* layers step */
panLayers.addEventListener('drop',e=>{
  e.preventDefault();const d=JSON.parse(e.dataTransfer.getData('text/plain'));
  if(d.type==='layer'&&layers.length<6){layers.push(d.color);renderCake(panLayers);toTopping.disabled=false;}
});
toTopping.addEventListener('click',()=>{
  stepLayers.classList.remove('active');stepTopping.classList.add('active');renderCake(panTopping,true);
});

/* toppings step */
panTopping.addEventListener('drop',e=>{
  e.preventDefault();const d=JSON.parse(e.dataTransfer.getData('text/plain'));
  if(d.type==='topping'){toppings.push(d.emoji);renderCake(panTopping,true);toFinish.disabled=false;}
});
toFinish.addEventListener('click',()=>{
  stepTopping.classList.remove('active');stepFinish.classList.add('active');
  const panFinish=document.getElementById('pan-finish');renderCake(panFinish,true);addLetterCandles(panFinish);

  const celebrate=()=>{
    if(blowCount===0){   // first blow
      inlineMsg.textContent=`Happy Birthday, ${recipient}!`;inlineMsg.style.display='block';
      confetti({particleCount:200,spread:100,origin:{y:0.6}});
    }else if(blowCount===1){   // second blow
      const clearMsg=hasPresets?caesarDecrypt(secretMessageCipher,secretShift):defaultClearMsg;
      overlayMsg.textContent=clearMsg;overlay.classList.add('visible');
      confetti({particleCount:180,spread:120,origin:{y:0.6}});
    }
    blowCount++;
  };
  window.addEventListener('click',celebrate);
  startBlowDetector(celebrate);
});

/* letter candles helper */
function addLetterCandles(pan){
  const chars=recipient.toUpperCase().split(''),total=chars.length*16+(chars.length-1)*10;
  chars.forEach((ch,i)=>{
    const x=-total/2+i*26+8;
    const c=document.createElement('div');
    c.style.cssText=`position:absolute;width:16px;height:46px;left:50%;transform:translateX(${x}px);
                     bottom:${layers.length*layerHeight+50}px;background:repeating-linear-gradient(45deg,#ffd1dc 0 4px,#ff8ba7 4px 8px);
                     display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;font-size:.7rem;text-shadow:0 0 2px #0005;`;
    c.textContent=ch;
    const f=document.createElement('div');
    f.style.cssText='position:absolute;width:16px;height:20px;left:50%;top:-20px;transform:translateX(-50%);background:radial-gradient(circle at 50% 60%,#fff 0 20%,#ffda66 20% 60%,#ff8c00 60% 100%);border-radius:50%/60% 60% 40% 40%;animation:flicker .4s infinite alternate;';
    c.appendChild(f);pan.appendChild(c);
  });
}

/* blow detector */
function startBlowDetector(cb){
  const start=stream=>{
    const ctx=new (window.AudioContext||window.webkitAudioContext)(),an=ctx.createAnalyser();an.fftSize=256;
    ctx.createMediaStreamSource(stream).connect(an);const data=new Uint8Array(an.frequencyBinCount);
    (function loop(){if(ctx.state==='suspended')ctx.resume();an.getByteFrequencyData(data);
      if(data.reduce((a,b)=>a+b,0)>100*data.length&&Date.now()-lastBlow>BLOW_COOLDOWN){lastBlow=Date.now();cb();}
      requestAnimationFrame(loop);})();
  };
  micStream?start(micStream):navigator.mediaDevices?.getUserMedia({audio:true}).then(start);
}
</script>
</body>
</html>
