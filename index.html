<!-- Full cake.html ‚Äì baking wizard with preset & decryption logic -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bake‚Äëa‚ÄëCake ‚Äì Wizard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
<style>
  :root{--bg:#fff7ec;--primary:#ff8ba7;--dark:#403d58;--radius:18px;}
  *{box-sizing:border-box;margin:0;padding:0;font-family:'DM Sans',sans-serif;user-select:none;}
  body{background:radial-gradient(circle at top left,#ffe5ec,var(--bg));color:var(--dark);display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:2rem 1rem 3rem;}
  h1{margin-bottom:1.2rem;font-size:2rem;text-align:center;}
  button{padding:.85rem 1.6rem;border-radius:9999px;background:var(--primary);color:#fff;font-size:1rem;border:none;cursor:pointer;transition:transform .1s;}
  button:disabled{opacity:.5;cursor:not-allowed;}button:active{transform:scale(.97);}
  .card{width:100%;max-width:460px;background:#fff;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.1);padding:1.6rem;display:flex;flex-direction:column;gap:1rem;}
  .step{display:none;flex-direction:column;gap:1rem;}.step.active{display:flex;}
  .workspace{display:flex;gap:.9rem;justify-content:center;}
  .palette{display:flex;flex-wrap:wrap;gap:.6rem;max-width:180px;align-content:flex-start;}
  .draggable{width:52px;height:52px;border-radius:var(--radius);border:2px solid var(--dark);display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:grab;}
  .pan{width:260px;height:320px;position:relative;border-bottom:10px solid #cacaca;border-radius:0 0 8px 8px;background:#fafafa;display:flex;justify-content:center;align-items:flex-end;}
  .layer{position:absolute;left:50%;transform:translateX(-50%);height:40px;border-radius:6px;box-shadow:0 0 0 4px #fff inset;}
  .topping{position:absolute;font-size:2.2rem;width:44px;height:44px;transform:translateX(-50%);}
  #inlineMsg{display:none;text-align:center;font-size:1.9rem;font-weight:700;margin-top:1rem;}
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .6s;}
  #overlay.visible{opacity:1;pointer-events:auto;}
  #overlayMsg{font-size:1.9rem;font-weight:700;color:#fff;opacity:0;transform:translateY(40px);transition:opacity .8s,transform .8s;text-align:center;max-width:80%;}
  #overlay.visible #overlayMsg{opacity:1;transform:translateY(0);}
  @keyframes flicker{from{transform:translateX(-50%) scaleY(1);}to{transform:translateX(-50%) scaleY(.9);}}
  input[type=text]{padding:.7rem 1rem;border:2px solid var(--primary);border-radius:var(--radius);font-size:1rem;width:100%;}
</style>
</head>
<body>
<h1>üéÇ Bake-a-Cake Birthday Card</h1>
<div class="card" id="wizard">
  <!-- STEP 0: mic -->
  <div class="step active" id="step-mic">
    <p style="text-align:center;font-weight:600;">To blow out the candle later, we‚Äôll need your mic.</p>
    <button id="enableMic">Enable Microphone</button>
    <button id="toName" disabled>Continue ‚Üí</button>
    <small id="micStatus" style="text-align:center;opacity:.7;"></small>
  </div>
  <!-- STEP 1: name (skip if preset) -->
  <div class="step" id="step-name">
    <p style="text-align:center;font-weight:600;">Who‚Äôs this cake for?</p>
    <input id="nameInput" type="text" placeholder="Type a name‚Ä¶" />
    <button id="toLayers" disabled>Continue ‚Üí</button>
  </div>
  <!-- STEP 2: layers -->
  <div class="step" id="step-layers">
    <p style="text-align:center;font-weight:600;">Drag layers onto the pan</p>
    <div class="workspace">
      <div id="palette-layers" class="palette">
        <div class="draggable" draggable="true" data-type="layer" data-color="#ff8ba7" style="background:#ff8ba7;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#a0e7e5" style="background:#a0e7e5;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#ffd166" style="background:#ffd166;"></div>
        <div class="draggable" draggable="true" data-type="layer" data-color="#cdb4db" style="background:#cdb4db;"></div>
      </div>
      <div id="pan-layers" class="pan" ondragover="event.preventDefault()"></div>
    </div>
    <button id="toTopping" disabled>Continue ‚Üí</button>
  </div>
  <!-- STEP 3: toppings -->
  <div class="step" id="step-topping">
    <p style="text-align:center;font-weight:600;">Add as many toppings as you like</p>
    <div class="workspace">
      <div id="palette-topping" class="palette">
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üçì">üçì</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üçí">üçí</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üç©">üç©</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üç™">üç™</div>
        <div class="draggable" draggable="true" data-type="topping" data-emoji="üßÅ">üßÅ</div>
      </div>
      <div id="pan-topping" class="pan" ondragover="event.preventDefault()"></div>
    </div>
    <button id="toFinish" disabled>Continue ‚Üí</button>
  </div>
  <!-- STEP 4: finish -->
  <div class="step" id="step-finish" style="align-items:center;">
    <p style="text-align:center;font-size:1.2rem;">Click or blow to blow out the candle!</p>
    <div id="pan-finish" class="pan" style="margin-bottom:1rem;"></div>
    <div id="inlineMsg"></div>
  </div>
</div>
<div id="overlay"><div id="overlayMsg"></div></div>
<script>
// ---------- URL PARAMS ----------
const p=new URLSearchParams(location.search);
const presetName=p.get('name')?decodeURIComponent(p.get('name')):null;
const cipher=p.get('msg')?decodeURIComponent(p.get('msg')):null;
const key=p.get('key')?parseInt(p.get('key')):null;
const hasPreset= presetName&&cipher&&key;
// ---------- Caesar helpers ----------
function decryptCaesar(str,shift){return str.split('').map(ch=>{const c=ch.charCodeAt(0);
  if(c>=65&&c<=90) return String.fromCharCode(((c-65-shift+2600)%26)+65);
  if(c>=97&&c<=122) return String.fromCharCode(((c-97-shift+2600)%26)+97);
  return ch;}).join('');}
const defaultSecondMsg='Happy birthday to the greatest person ever';
// ---------- STATE ----------
let layers=[],toppings=[],recipient=presetName||'Birthday Star';
let micStream=null,blowCount=0,lastBlow=0;
const layerHeight=40,BLOW_COOLDOWN=1000;
// ---------- DOM refs ----------
const stepMic=document.getElementById('step-mic'),stepName=document.getElementById('step-name'),stepLayers=document.getElementById('step-layers'),stepTopping=document.getElementById('step-topping'),stepFinish=document.getElementById('step-finish');
const enableMic=document.getElementById('enableMic'),toName=document.getElementById('toName'),micStatus=document.getElementById('micStatus');
const nameInput=document.getElementById('nameInput'),toLayers=document.getElementById('toLayers');
const panLayers=document
